import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import {
  Box,
  Container,
  Typography,
  Pagination,
  CircularProgress,
  Alert,
  Chip,
} from '@mui/material';
import TruckCenterCard from '../../components/cards/TruckCenterCard';
import ListingFilters, { FilterValues } from '../../components/filters/ListingFilters';
import ReportModal from '../../components/ReportModal';
import { useAuth } from '../../context/AuthContext';
import { useNotification } from '../../context/NotificationContext';
import { api } from '../../services/api';
import { messageService } from '../../services/messageService';
import { useConfirmDialog } from '../../hooks/useConfirmDialog';

interface Listing {
  id: string;
  title: string;
  price: number;
  year: number;
  km?: number;
  kilometers: number;
  city_name: string;
  district_name: string;
  description: string;
  images: string[];
  created_at: string;
  seller_phone?: string;
  // Backend'den gelen relation'lar
  categories?: {
    name: string;
  };
  vehicle_types?: {
    name: string;
  };
  brands?: {
    name: string;
  };
  models?: {
    name: string;
  };
  cities?: {
    name: string;
  };
  districts?: {
    name: string;
  };
  users?: {
    id: string;
    first_name: string;
    last_name: string;
    phone: string;
  };
  listing_images?: Array<{
    url: string;
    alt?: string;
    sort_order: number;
  }>;
  // Eski formatla uyumluluk i√ßin
  category: {
    name: string;
  };
  brand: {
    name: string;
  };
  model: {
    name: string;
  };
  user: {
    first_name: string;
    last_name: string;
    phone: string;
  };
  views?: number;
  isFavorite?: boolean;
}

interface ListingsResponse {
  success: boolean;
  data: {
    listings: Listing[];
    pagination: {
      page: number;
      limit: number;
      total: number;
      pages: number;
    };
  };
}

const AllListingsPage: React.FC = () => {
  const { user } = useAuth();
  const { showErrorNotification } = useNotification();
  const { confirm } = useConfirmDialog();
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const categoryParam = searchParams.get('category');
  
  const [rawListings, setRawListings] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(0);
  const itemsPerPage = 12;

  // Filter state
  const [activeFilters, setActiveFilters] = useState<FilterValues>({});

  // Report modal state
  const [reportModal, setReportModal] = useState<{
    open: boolean;
    listingId?: string;
    listingTitle?: string;
  }>({ open: false });

  // Memoized transform function
  const transformListing = useCallback((listing: any) => {
    // Data validation - prevent undefined/null listings
    if (!listing || typeof listing !== 'object') {
      console.error('‚ùå Invalid listing object:', listing);
      return null;
    }
    
    if (!listing.id) {
      console.error('‚ùå Listing missing ID:', listing);
      return null;
    }
    
    console.log('üîç Transforming listing:', listing.id, 'created_at:', listing.created_at);
    const getValidDate = (dateValue: any) => {
      if (!dateValue) return new Date();
      
      const date = new Date(dateValue);
      if (isNaN(date.getTime())) {
        console.warn('‚ö†Ô∏è Invalid date value:', dateValue, 'using current date');
        return new Date();
      }
      return date;
    };
    
    // Resim kaynaklarƒ±nƒ± birle≈ütir
    const images = [];
    
    // listing_images tablosundan resimleri al
    if (listing.listing_images && Array.isArray(listing.listing_images)) {
      images.push(...listing.listing_images.map((img: any) => img.url));
    }
    
    // JSON images alanƒ±ndan resimleri al
    if (listing.images) {
      let jsonImages = [];
      try {
        // Eƒüer string ise parse et
        jsonImages = typeof listing.images === 'string' ? JSON.parse(listing.images) : listing.images;
        if (Array.isArray(jsonImages)) {
          images.push(...jsonImages);
        }
      } catch (error) {
        console.warn('JSON images parse error:', error);
      }
    }
    
    const validDate = getValidDate(listing.created_at);
    
    // Seller bilgilerini belirle - users relation'ƒ±ndan kurumsal bilgileri al
    const sellerName = listing.users?.is_corporate 
      ? listing.users.company_name || listing.seller_name || 'ƒ∞lan Sahibi'
      : listing.seller_name || `${listing.users?.first_name || ''} ${listing.users?.last_name || ''}`.trim() || 'ƒ∞lan Sahibi';
    const sellerPhone = listing.users?.phone || listing.seller_phone || 'Telefon Belirtilmemi≈ü';
    
    // Debug: Kurumsal bilgileri kontrol et
    if (listing.users?.is_corporate) {
      console.log('üè¢ Kurumsal ilan bulundu:', {
        id: listing.id,
        title: listing.title,
        is_corporate: listing.users.is_corporate,
        company_name: listing.users.company_name,
        user_id: listing.user_id
      });
    }
    
    // Debug: Backend'den gelen users bilgilerini logla
    if (listing.title.includes('Mercedes')) {
      console.log('üîç Mercedes ilan users data:', {
        title: listing.title,
        users: listing.users,
        is_corporate: listing.users?.is_corporate,
        company_name: listing.users?.company_name
      });
    }
    
    return {
      id: listing.id,
      title: listing.title,
      price: listing.price,
      category: listing.categories?.name || listing.vehicle_types?.name || 'Kategori Belirtilmemi≈ü',
      brand: listing.brands?.name || 'Marka',
      model: `${listing.brands?.name || ' Marka'} ${listing.models?.name || 'Model'}`,
      year: listing.year,
      km: listing.km || 0,
      kilometers: listing.km || 0,
      city: listing.cities?.name || '≈ûehir',
      district: listing.districts?.name || 'ƒ∞l√ße',
      location: `${listing.cities?.name || '≈ûehir'}, ${listing.districts?.name || 'ƒ∞l√ße'}`,
      description: listing.description,
      image: images.length > 0 ? images[0] : '', // ƒ∞lk resmi ana resim olarak kullan
      images: images.filter((img, index, arr) => arr.indexOf(img) === index), // Duplicate'larƒ± kaldƒ±r
      publishDate: validDate.toLocaleDateString('tr-TR'),
      user_id: listing.user_id || listing.users?.id, // √ñnce direkt user_id, sonra users ili≈ükisinden id
      seller: {
        name: sellerName,
        phone: sellerPhone,
        is_corporate: listing.users?.is_corporate || false,
        company_name: listing.users?.company_name || '',
      },
      owner: {
        name: sellerName,
        phone: sellerPhone,
      },
      details: {
        year: listing.year,
        km: listing.km || 0,
        location: `${listing.cities?.name || '≈ûehir'}, ${listing.districts?.name || 'ƒ∞l√ße'}`,
        description: listing.description,
      },
      views: listing.views || 0,
      isFavorite: listing.isFavorite || false,
      status: 'APPROVED' as const,
      createdAt: validDate.toISOString(),
      updatedAt: validDate.toISOString(),
    };
  }, []);

  // Handle message click function
  const handleMessageClick = useCallback(async (listingId: string) => {
    if (!user) {
      navigate('/auth');
      return;
    }
    
    // Kendi ilanƒ±na mesaj g√∂ndermeyi engelle
    const listing = listings.find(l => l && l.id === listingId);
    if (listing && listing.user_id === user.id) {
      await confirm({
        title: 'Uyarƒ±',
        description: 'Kendi ilanƒ±nƒ±za mesaj g√∂nderemezsiniz!',
        severity: 'warning',
        confirmText: 'Tamam',
        cancelText: ''
      });
      return;
    }
    
    navigate(`/real-time-messages?listing=${listingId}`);
  }, [user, navigate, confirm]);

  // Memoized transformed listings
  const listings = useMemo(() => {
    console.log('üîÑ Memoizing listings transformation...');
    console.log('üîÑ Raw listings count:', rawListings.length);
    
    if (!rawListings.length) return [];
    
    return rawListings.map((listing, index) => {
      console.log(`üîÑ Processing listing ${index + 1}/${rawListings.length}:`, listing.id);
      const transformed = transformListing(listing);
      if (!transformed) {
        console.warn('‚ö†Ô∏è Skipping invalid listing:', listing.id);
        return null;
      }
      return transformed;
    }).filter(Boolean); // Remove null values
  }, [rawListings]);

  const loadListings = async () => {
    try {
      setLoading(true);
      console.log('üîç Loading listings from API...');
      console.log('üîç Category Param:', categoryParam);
      console.log('üîç Current Page:', currentPage);
      console.log('üîç Active Filters:', activeFilters);
      
      const params: any = {
        page: currentPage,
        limit: itemsPerPage
      };
      
      // Kategori filtresi ekle (URL parametresinden)
      if (categoryParam) {
        params.category = categoryParam;
        console.log('üéØ Adding category filter:', categoryParam);
      }
      
      // Aktif filtreleri ekle
      if (activeFilters.search) {
        params.search = activeFilters.search;
      }
      if (activeFilters.category) {
        params.category = activeFilters.category;
      }
      if (activeFilters.brand) {
        params.brand = activeFilters.brand;
      }
      if (activeFilters.model) {
        params.model = activeFilters.model;
      }
      if (activeFilters.city) {
        params.city = activeFilters.city;
      }
      if (activeFilters.district) {
        params.district = activeFilters.district;
      }
      if (activeFilters.yearMin) {
        params.yearMin = activeFilters.yearMin;
      }
      if (activeFilters.yearMax) {
        params.yearMax = activeFilters.yearMax;
      }
      if (activeFilters.priceMin) {
        params.priceMin = activeFilters.priceMin;
      }
      if (activeFilters.priceMax) {
        params.priceMax = activeFilters.priceMax;
      }
      if (activeFilters.kmMin) {
        params.kmMin = activeFilters.kmMin;
      }
      if (activeFilters.kmMax) {
        params.kmMax = activeFilters.kmMax;
      }
      if (activeFilters.isCorporate !== undefined) {
        params.isCorporate = activeFilters.isCorporate;
      }
      
      console.log('üì§ API request params:', params);
      
      const response = await api.get<ListingsResponse>('/listings', { params });
      
      // Backend response format: { success: true, data: { listings: [], pagination: {} } }
      const responseData = response.data.data || response.data;
      
      if (responseData.listings && Array.isArray(responseData.listings)) {
        // Deep clone to prevent reference issues
        const listingsClone = JSON.parse(JSON.stringify(responseData.listings));
        setRawListings(listingsClone);
        setTotalPages(responseData.pagination.pages);
        console.log('‚úÖ Raw listings set:', listingsClone.length, 'for category:', categoryParam || 'all');
      } else {
        console.warn('‚ö†Ô∏è No listings data or invalid format', { responseData });
        setRawListings([]);
      }
    } catch (error) {
      console.error('ƒ∞lanlar y√ºklenemedi:', error);
      setError('ƒ∞lanlar y√ºklenemedi. L√ºtfen tekrar deneyin.');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    console.log('üîÑ Category param changed:', categoryParam);
    setCurrentPage(1); // Kategori deƒüi≈ütiƒüinde ilk sayfaya d√∂n
    loadListings();
  }, [categoryParam]);

  useEffect(() => {
    console.log('üîÑ Current page changed:', currentPage);
    loadListings();
  }, [currentPage]);

  useEffect(() => {
    console.log('üîÑ Active filters changed:', activeFilters);
    setCurrentPage(1); // Filtre deƒüi≈ütiƒüinde ilk sayfaya d√∂n
    loadListings();
  }, [activeFilters]);

  const handleFiltersChange = (newFilters: FilterValues) => {
    console.log('üéØ Filters changed:', newFilters);
    setActiveFilters(newFilters);
  };

  const handleFavoriteClick = (id: string) => {
    console.log('Favorileme:', id);
  };

  const handleViewDetails = (id: string) => {
    navigate(`/listing/${id}`);
  };

  const handleVisitStore = (userId: string, companyName: string) => {
    // Kurumsal maƒüaza sayfasƒ±na y√∂nlendir
    navigate(`/store/${userId}`, { 
      state: { companyName } 
    });
  };

  const handleSendMessage = async (listingId: string) => {
    if (!user) {
      navigate('/auth/login');
      return;
    }
    
    // Kendi ilanƒ±na mesaj g√∂ndermeyi engelle
    const listing = listings.find(l => l && l.id === listingId);
    if (!listing) {
      console.error('‚ùå Listing not found:', listingId);
      return;
    }
    
    if (listing.user_id === user.id) {
      await confirm({
        title: 'Uyarƒ±',
        description: 'Kendi ilanƒ±nƒ±za mesaj g√∂nderemezsiniz!',
        severity: 'warning',
        confirmText: 'Tamam',
        cancelText: ''
      });
      return;
    }
    
    try {
      console.log('üî• Starting conversation for listing:', listingId);
      
      // Backend'e conversation ba≈ülatma isteƒüi g√∂nder
      const response = await messageService.startConversation({
        listingId: listingId,
        otherUserId: listing.user_id,
        initialMessage: `${listing.title} ilanƒ±nƒ±z hakkƒ±nda bilgi almak istiyorum.`
      });
      
      if (response.success && response.conversation) {
        console.log('‚úÖ Conversation started:', response.conversation);
        // Conversation ID ile mesajla≈üma sayfasƒ±na git
        navigate(`/real-time-messages?conversation=${response.conversation.id}`);
      } else {
        console.error('‚ùå Failed to start conversation:', response);
        navigate(`/real-time-messages?listing=${listingId}`);
      }
    } catch (error) {
      console.error('‚ùå Error starting conversation:', error);
      // Fallback: Listing ID ile git
      navigate(`/real-time-messages?listing=${listingId}`);
    }
  };

  const handleReport = (id: string) => {
    // Giri≈ü kontrol√º
    if (!user) {
      navigate('/auth/login');
      return;
    }
    // Kendi ilanƒ±nƒ± ≈üikayet etme kontrol√º
    const listing = listings.find(l => l && l.id === id);
    if (listing && listing.user_id && user && listing.user_id === user.id) {
      showErrorNotification('Kendi ilanƒ±nƒ±zƒ± ≈üikayet edemezsiniz.');
      return;
    }
    setReportModal({
      open: true,
      listingId: id,
      listingTitle: listing?.title || 'ƒ∞lan'
    });
  };

  const handlePageChange = (_event: React.ChangeEvent<unknown>, page: number) => {
    setCurrentPage(page);
  };

  // Kategori isimlerini T√ºrk√ßeye √ßevir
  const getCategoryDisplayName = (category: string | null): string => {
    if (!category) return 'T√ºm ƒ∞lanlar';
    
    const categoryNames: Record<string, string> = {
      'cekici': '√áekici',
      'dorse': 'Dorse', 
      'kamyon': 'Kamyon & Kamyonet',
      'romork': 'R√∂mork',
      'minibus': 'Minib√ºs & Midib√ºs',
      'otobus': 'Otob√ºs',
      'karoser': 'Karoser & √úst Yapƒ±',
      'kurtarici': 'Oto Kurtarƒ±cƒ± & Ta≈üƒ±yƒ±cƒ±'
    };
    
    return categoryNames[category] || 'T√ºm ƒ∞lanlar';
  };

  console.log('Component state:', { loading, error, listingsCount: listings.length });

  if (error) {
    return (
      <Container maxWidth="xl" sx={{ py: 2 }}>
        <Alert severity="error">{error}</Alert>
      </Container>
    );
  }

  return (
    <Container maxWidth="xl" sx={{ py: { xs: 1, md: 2 }, px: { xs: 1, sm: 2, md: 3 } }}> {/* Mobile'da daha az padding */}
      {/* Filtreleme Sistemi */}
      <ListingFilters
        onFiltersChange={handleFiltersChange}
        initialFilters={activeFilters}
        loading={loading}
      />
      
      {loading ? (
        <Box sx={{ display: 'flex', justifyContent: 'center', py: 8 }}>
          <CircularProgress />
          <Typography sx={{ ml: 2 }}>ƒ∞lanlar y√ºkleniyor...</Typography>
        </Box>
      ) : (
        <>
          
          {/* ƒ∞lan Kartlarƒ± - Responsive Grid */}
          <Box 
            sx={{ 
              display: 'grid',
              gridTemplateColumns: {
                xs: '1fr',                    // Mobile: 1 kolon
                sm: '1fr',                    // Small tablet: 1 kolon
                md: 'repeat(2, 1fr)',         // Medium tablet: 2 kolon
                lg: 'repeat(2, 1fr)',         // Desktop: 2 kolon
                xl: 'repeat(3, 1fr)'          // Large desktop: 3 kolon
              },
              gap: { xs: 2, sm: 2.5, md: 3, lg: 3.5 }, // Gap artƒ±rƒ±ldƒ±
              alignItems: "stretch", // ‚úÖ y√ºkseklikleri e≈üitle
              mb: 4,
              // Mobile'da daha kompakt g√∂r√ºn√ºm
              '& .MuiCard-root': {
                maxWidth: { xs: '100%', md: 460 } // Max width artƒ±rƒ±ldƒ±
              }
            }}
          >
            {listings.filter(listing => listing !== null).map(listing => {
              console.log('üéØ Rendering TruckCenterCard for listing:', {
                id: listing!.id,
                title: listing!.title,
                seller_is_corporate: listing!.seller.is_corporate,
                seller_company_name: listing!.seller.company_name,
                user_id: listing!.user_id
              });
              
              return (
                <TruckCenterCard
                  key={listing!.id}
                  listing={listing!}
                  isOwn={!!user && listing!.user_id === user.id}
                  onFavoriteClick={handleFavoriteClick}
                  onViewDetails={handleViewDetails}
                  onSendMessage={handleSendMessage}
                  onReport={handleReport}
                  onVisitStore={handleVisitStore}
                />
              );
            })}
          </Box>

          {/* Sayfalama */}
          {totalPages > 1 && (
            <Box sx={{ display: 'flex', justifyContent: 'center', mt: { xs: 3, md: 4 } }}>
              <Pagination
                count={totalPages}
                page={currentPage}
                onChange={handlePageChange}
                color="primary"
                size="medium" // Tek size kullan
                sx={{
                  '& .MuiPaginationItem-root': {
                    fontSize: { xs: '0.875rem', md: '1rem' }
                  }
                }}
              />
            </Box>
          )}

          {/* Sonu√ß bulunamadƒ± */}
          {listings.length === 0 && !loading && (
            <Box sx={{ textAlign: 'center', py: 8 }}>
              <Typography variant="h6" color="text.secondary">
                Hen√ºz ilan bulunmamaktadƒ±r
              </Typography>
            </Box>
          )}
        </>
      )}

      {/* Report Modal */}
      <ReportModal
        open={reportModal.open}
        listingId={reportModal.listingId || ''}
        listingTitle={reportModal.listingTitle || ''}
        onClose={() => setReportModal({ open: false })}
      />
    </Container>
  );
};

export default AllListingsPage;
